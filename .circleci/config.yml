version: 2.1

jobs:
  build:
    docker:
      - image: fr3akyphantom/droid-builder:latest
    working_directory: /home/builder/aosp
    steps:
      - run:
          name: AIO Build
          command: |
            #sudo chmod 777 /var/cache/debconf/
            #sudo chmod 777 /var/cache/debconf/passwords.dat
            #echo 'debconf debconf/frontend select Noninteractive' | debconf-set-selections
            #sudo apt-get -y -q update
            #sudo apt-get -y -q install bc bison build-essential curl flex g++-multilib gcc-multilib git gnupg gperf imagemagick lib32ncurses5-dev lib32z1-dev liblz4-tool libncurses5-dev libsdl1.2-dev libwxgtk3.0-gtk3-dev libxml2 libxml2-utils lunzip lzop pngcrush schedtool squashfs-tools xsltproc zip zlib1g-dev openjdk-8-jdk python perl git git-lfs libncurses5 xmlstarlet virtualenv xz-utils rr jq
            sudo fallocate -l 16G /swapfile
            sudo chmod 600 /swapfile
            sudo mkswap /swapfile
            sudo swapon /swapfile
            sudo sysctl vm.swappiness=90
            sudo swapon --show
            mkdir -p /tmp/rom
            cd /tmp/rom
            git config --global user.email tasinayon9@gmail.com
            git config --global user.name TasinAyon
            git config --global color.ui false
            repo init --depth=1 -u https://android.googlesource.com/platform/manifest/ -b master
            repo sync -c --force-sync --no-tags --no-clone-bundle -j$(nproc --all) || repo sync -c --force-sync --no-tags --no-clone-bundle -j8
            . build/envsetup.sh
            lunch gsi_arm64-userdebug
            #export CCACHE_DIR=/tmp/ccache
            #export CCACHE_EXEC=$(which ccache)
            #export USE_CCACHE=1
            #export SDCLANG_PATH=vendor/qcom/proprietary/llvm-arm-toolchain-ship/8.0/bin
            #ccache -M 20G
            #ccache -o compression=true
            #ccache -z
            WITHOUT_CHECK_API=true make -j$(nproc --all) systemimage
            zip -r out/target/product/gsi_arm64/system.7z out/target/product/gsiarm64/system*.img
            curl -sL https://git.io/file-transfer | sh
            ./transfer wet out/target/product/gsi_arm64/system.7z
            echo " "

workflows:
  version: 2
  build_and_test:
    jobs:
      - build
